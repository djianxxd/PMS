{{define "content"}}
<div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-slate-800 mb-2">备份还原</h1>
        <p class="text-slate-600">备份和还原您的个人数据，确保数据安全</p>
    </div>

    <!-- Backup Section -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500 mr-4">
                <i class="fas fa-download text-xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-slate-800">数据备份</h2>
                <p class="text-sm text-slate-600">下载包含所有数据的完整备份文件</p>
            </div>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <h3 class="font-semibold text-blue-800 mb-2">备份内容包括：</h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>• 所有收支记录</li>
                <li>• 习惯数据和打卡记录</li>
                <li>• 待办事项</li>
                <li>• 成就徽章</li>
                <li>• 财务目标</li>
            </ul>
        </div>

        <button onclick="createBackup()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center">
            <i class="fas fa-download mr-2"></i>
            创建备份
        </button>
    </div>

    <!-- Restore Section -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-orange-100 text-orange-500 mr-4">
                <i class="fas fa-upload text-xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold text-slate-800">数据还原</h2>
                <p class="text-sm text-slate-600">从备份文件恢复数据（将覆盖当前数据）</p>
            </div>
        </div>

        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-orange-500 mr-2 mt-1"></i>
                <div class="text-sm text-orange-700">
                    <p class="font-semibold mb-1">重要提醒：</p>
                    <p>还原操作将覆盖当前所有数据。建议先创建当前数据的备份。</p>
                </div>
            </div>
        </div>

        <form id="restoreForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">选择备份文件</label>
                <input type="file" id="backupFile" accept=".json" class="block w-full text-sm text-slate-600 border border-slate-300 rounded-lg cursor-pointer bg-white focus:outline-none focus:border-blue-500 p-3">
                <p class="text-xs text-slate-500 mt-1">仅支持 .json 格式的备份文件</p>
            </div>
            
            <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center">
                <i class="fas fa-upload mr-2"></i>
                还原数据
            </button>
        </form>
    </div>

    <!-- Status Messages -->
    <div id="successMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span class="text-green-700" id="successText"></span>
        </div>
    </div>

    <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
            <span class="text-red-700" id="errorText"></span>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-slate-700">处理中，请稍候...</p>
        </div>
    </div>
</div>

<script>
    function createBackup() {
        window.open('/backup', '_blank');
        showMessage('备份文件正在下载中...', 'success');
    }

    document.getElementById('restoreForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('backupFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showMessage('请选择备份文件', 'error');
            return;
        }

        if (!file.name.endsWith('.json')) {
            showMessage('请选择有效的 JSON 备份文件', 'error');
            return;
        }

        // Confirm restore operation
        if (!confirm('确定要还原数据吗？这将覆盖当前所有数据。')) {
            return;
        }

        showLoading(true);
        
        const formData = new FormData();
        formData.append('backup', file);

        try {
            const response = await fetch('/restore', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                let message = '数据还原成功！\n\n';
                message += `备份时间: ${new Date(result.backup_date).toLocaleString()}\n`;
                message += `备份版本: ${result.version}\n\n`;
                message += '还原的数据量:\n';
                for (const [key, count] of Object.entries(result.restored)) {
                    const label = {
                        'transactions': '收支记录',
                        'habits': '习惯',
                        'habit_logs': '打卡记录',
                        'todos': '待办事项',
                        'badges': '成就徽章',
                        'finance_goals': '财务目标'
                    }[key] || key;
                    message += `• ${label}: ${count} 条\n`;
                }
                
                showMessage(message, 'success');
                
                // Reload page after successful restore
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                let errorMsg = '还原失败:\n';
                result.errors.forEach(error => {
                    errorMsg += `• ${error}\n`;
                });
                showMessage(errorMsg, 'error');
            }
        } catch (error) {
            showMessage('还原过程中发生错误: ' + error.message, 'error');
        } finally {
            showLoading(false);
            fileInput.value = ''; // Clear file input
        }
    });

    function showMessage(message, type) {
        hideAllMessages();
        
        const messageEl = type === 'success' ? 
            document.getElementById('successMessage') : 
            document.getElementById('errorMessage');
        
        const textEl = type === 'success' ? 
            document.getElementById('successText') : 
            document.getElementById('errorText');
        
        textEl.textContent = message;
        messageEl.classList.remove('hidden');
        
        // Auto hide after 5 seconds for success messages
        if (type === 'success') {
            setTimeout(hideAllMessages, 5000);
        }
    }

    function hideAllMessages() {
        document.getElementById('successMessage').classList.add('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
    }

    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
        }
    }
</script>
{{end}}