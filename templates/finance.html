{{define "content"}}
<div class="max-w-7xl mx-auto">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-8 animate-fade-in">
        <div class="glass-panel rounded-2xl p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold gradient-text mb-2">ğŸ’° æ”¶æ”¯ç®¡ç†</h1>
                    <p class="text-gray-600">è®°å½•æ¯ä¸€ç¬”æ”¶æ”¯ï¼ŒæŒæ§è´¢åŠ¡çŠ¶å†µ</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-center">
                        <p class="text-sm text-gray-500">æœ¬æœˆæ”¯å‡º</p>
                        <p class="text-xl font-bold text-red-500">Â¥{{printf "%.2f" .MonthlyExpense}}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500">æœ¬æœˆæ”¶å…¥</p>
                        <p class="text-xl font-bold text-green-500">Â¥{{printf "%.2f" .MonthlyIncome}}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- è®°è´¦è¡¨å• -->
        <div class="lg:col-span-1">
            <div class="glass-panel rounded-2xl p-6 animate-slide-up sticky top-6">
                <div class="flex items-center mb-6">
                    <div class="p-3 rounded-2xl bg-gradient-to-br from-blue-400 to-purple-500 text-white mr-4">
                        <i class="fas fa-edit text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">è®°ä¸€ç¬”</h2>
                        <p class="text-sm text-gray-600">å¿«é€Ÿè®°å½•æ”¶æ”¯æ˜ç»†</p>
                    </div>
                </div>

                <form action="/finance/add" method="POST" class="space-y-5">
                    <!-- ç±»å‹é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">æ”¶æ”¯ç±»å‹</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="relative">
                                <input type="radio" name="type" value="expense" checked class="peer sr-only">
                                <div class="p-4 rounded-xl border-2 border-gray-200 cursor-pointer transition-all peer-checked:border-red-400 peer-checked:bg-red-50 hover:border-red-300">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-arrow-up text-2xl mb-2 text-red-500"></i>
                                        <span class="font-medium">æ”¯å‡º</span>
                                    </div>
                                </div>
                            </label>
                            <label class="relative">
                                <input type="radio" name="type" value="income" class="peer sr-only">
                                <div class="p-4 rounded-xl border-2 border-gray-200 cursor-pointer transition-all peer-checked:border-green-400 peer-checked:bg-green-50 hover:border-green-300">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-arrow-down text-2xl mb-2 text-green-500"></i>
                                        <span class="font-medium">æ”¶å…¥</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- é‡‘é¢è¾“å…¥ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">é‡‘é¢</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 text-lg">Â¥</span>
                            <input type="number" step="0.01" name="amount" required 
                                   class="input-field w-full pl-10 pr-4 py-3 rounded-xl border-2 border-transparent focus:border-blue-400 text-lg font-semibold"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <!-- åˆ†ç±»é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">åˆ†ç±»</label>
                        <select name="category_id" id="categorySelect" class="input-field w-full px-4 py-3 rounded-xl appearance-none cursor-pointer bg-white">
                            <option value="">é€‰æ‹©åˆ†ç±»...</option>
                            <!-- æ”¯å‡ºåˆ†ç±» -->
                            <optgroup id="expenseCategories" label="ğŸ”´ æ”¯å‡ºåˆ†ç±»">
                                {{range .Categories}}
                                    {{if eq .Type "expense"}}
                                        <option value="{{.ID}}" class="text-red-600">ğŸ”´ {{.Name}}</option>
                                    {{end}}
                                {{end}}
                            </optgroup>
                            <!-- æ”¶å…¥åˆ†ç±» -->
                            <optgroup id="incomeCategories" label="ğŸŸ¢ æ”¶å…¥åˆ†ç±»" style="display: none;">
                                {{range .Categories}}
                                    {{if eq .Type "income"}}
                                        <option value="{{.ID}}" class="text-green-600">ğŸŸ¢ {{.Name}}</option>
                                    {{end}}
                                {{end}}
                            </optgroup>
                            <option value="custom" class="text-purple-600">ğŸŸ£ è‡ªå®šä¹‰åˆ†ç±»</option>
                        </select>
                        <div class="mt-3">
                            <input type="text" name="custom_category" 
                                   class="input-field w-full px-4 py-2 rounded-xl text-sm"
                                   placeholder="âœï¸ è¾“å…¥è‡ªå®šä¹‰åˆ†ç±»åç§°...">
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-lightbulb text-yellow-500"></i> 
                                è‡ªå®šä¹‰åˆ†ç±»ä¼šè‡ªåŠ¨ä¿å­˜
                            </p>
                        </div>
                    </div>

                    <!-- å¤‡æ³¨è¾“å…¥ -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">å¤‡æ³¨</label>
                        <textarea name="note" rows="3" 
                                  class="input-field w-full px-4 py-3 rounded-xl resize-none"
                                  placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯..."></textarea>
                    </div>

                    <!-- æäº¤æŒ‰é’® -->
                    <button type="submit" class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg shadow-lg">
                        <i class="fas fa-save mr-2"></i>
                        ä¿å­˜è®°å½•
                    </button>
                </form>
            </div>

            <!-- ç›®æ ‡è¿›åº¦ -->
            <div class="glass-panel rounded-2xl p-6 mt-6 animate-slide-up" style="animation-delay: 0.2s;">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-bullseye text-purple-500 mr-2"></i>
                    æœˆåº¦ç›®æ ‡
                </h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">é¢„ç®—è¿›åº¦</span>
                        <span class="text-sm font-semibold">68%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-blue-400 to-purple-500 h-3 rounded-full" style="width: 68%"></div>
                    </div>
                    <p class="text-xs text-gray-500">å·²ä½¿ç”¨ Â¥0.00 / Â¥0.00</p>
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“è®°å½• -->
        <div class="lg:col-span-2">
            <div class="glass-panel rounded-2xl overflow-hidden animate-fade-in" style="animation-delay: 0.3s;">
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-list text-blue-500 mr-2"></i>
                            äº¤æ˜“è®°å½•
                        </h3>
                        <div class="flex items-center space-x-3">
                            <button class="px-4 py-2 text-sm bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors">
                                <i class="fas fa-filter mr-1"></i>ç­›é€‰
                            </button>
                            <button class="px-4 py-2 text-sm bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-colors">
                                <i class="fas fa-download mr-1"></i>å¯¼å‡º
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-sm border-b border-gray-100">
                                <th class="px-6 py-4 text-left">æ—¥æœŸ</th>
                                <th class="px-6 py-4 text-left">åˆ†ç±»</th>
                                <th class="px-6 py-4 text-left">å¤‡æ³¨</th>
                                <th class="px-6 py-4 text-right">é‡‘é¢</th>
                                <th class="px-6 py-4 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Transactions}}
                            <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors group">
                                <td class="px-6 py-4">
                                    <div class="text-gray-600">{{.Date.Format "2006-01-02"}}</div>
                                    <div class="text-xs text-gray-400">{{.Date.Format "15:04"}}</div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {{if eq .Type "income"}}bg-green-100 text-green-700{{else}}bg-red-100 text-red-700{{end}}">
                                        {{if eq .Type "income"}}<i class="fas fa-arrow-down mr-1"></i>{{else}}<i class="fas fa-arrow-up mr-1"></i>{{end}}
                                        {{.Category}}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-gray-600">{{.Note}}</div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="font-semibold text-lg {{if eq .Type "income"}}text-green-500{{else}}text-red-500{{end}}">
                                        {{if eq .Type "income"}}+{{else}}-{{end}}Â¥{{printf "%.2f" .Amount}}
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <div class="flex items-center justify-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form action="/finance/delete" method="POST" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ');" class="inline">
                                            <input type="hidden" name="id" value="{{.ID}}">
                                            <button type="submit" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="5" class="px-6 py-16 text-center">
                                    <div class="text-gray-400">
                                        <i class="fas fa-inbox text-6xl mb-4 block"></i>
                                        <p class="text-lg font-medium">æš‚æ— è®°å½•</p>
                                        <p class="text-sm mt-2">å¼€å§‹è®°å½•æ‚¨çš„ç¬¬ä¸€ç¬”æ”¶æ”¯å§ï¼</p>
                                    </div>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                {{if gt (len .Transactions) 0}}
                <div class="p-4 border-t border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            æ˜¾ç¤º 1-10 æ¡ï¼Œå…± {{len .Transactions}} æ¡è®°å½•
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="px-3 py-1 text-sm bg-blue-500 text-white rounded-lg">1</span>
                            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors">
                                2
                            </button>
                            <button class="px-3 py-1 text-sm bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
    </div>
</div>

<script>
    // æ·»åŠ è¡¨æ ¼è¡ŒåŠ¨ç”»
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach((row, index) => {
            row.style.animationDelay = (0.1 * index) + 's';
            row.classList.add('animate-slide-up');
        });
    });

    // é‡‘é¢è¾“å…¥æ ¼å¼åŒ–
    const amountInput = document.querySelector('input[name="amount"]');
    if (amountInput) {
        amountInput.addEventListener('input', function(e) {
            let value = e.target.value;
            // å…è®¸æ•°å­—å’Œå°æ•°ç‚¹
            value = value.replace(/[^\d.]/g, '');
            // é™åˆ¶åªèƒ½æœ‰ä¸€ä¸ªå°æ•°ç‚¹
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            e.target.value = value;
        });
    }

    // åˆ†ç±»æ˜¾ç¤ºåˆ‡æ¢
    function updateCategoryVisibility(type) {
        const expenseGroup = document.getElementById('expenseCategories');
        const incomeGroup = document.getElementById('incomeCategories');
        const select = document.getElementById('categorySelect');
        
        if (type === 'income') {
            expenseGroup.style.display = 'none';
            incomeGroup.style.display = 'block';
            // é‡ç½®é€‰æ‹©ï¼Œè‡ªåŠ¨é€‰ä¸­æ”¶å…¥åˆ†ç»„çš„ç¬¬ä¸€ä¸ªé€‰é¡¹
            const firstIncomeOption = incomeGroup.querySelector('option:not([style*="display: none"])');
            if (firstIncomeOption) {
                select.value = firstIncomeOption.value;
            }
        } else {
            expenseGroup.style.display = 'block';
            incomeGroup.style.display = 'none';
            // é‡ç½®é€‰æ‹©ï¼Œè‡ªåŠ¨é€‰ä¸­æ”¯å‡ºåˆ†ç»„çš„ç¬¬ä¸€ä¸ªé€‰é¡¹
            const firstExpenseOption = expenseGroup.querySelector('option:not([style*="display: none"])');
            if (firstExpenseOption) {
                select.value = firstExpenseOption.value;
            }
        }
    }

    // ç›‘å¬ç±»å‹é€‰æ‹©å˜åŒ–
    document.querySelectorAll('input[name="type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateCategoryVisibility(this.value);
        });
    });

    // åˆå§‹åŒ–åˆ†ç±»å¯è§æ€§ï¼ˆé»˜è®¤æ˜¾ç¤ºæ”¯å‡ºåˆ†ç±»ï¼‰
    const initialType = document.querySelector('input[name="type"]:checked')?.value || 'expense';
    updateCategoryVisibility(initialType);

    // å¿«é€Ÿè®°è´¦å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // Alt + E: å¿«é€Ÿè®°å½•æ”¯å‡º
        if (e.altKey && e.key === 'e') {
            document.querySelector('input[value="expense"]').checked = true;
            updateCategoryOptions('expense');
            amountInput?.focus();
        }
        // Alt + I: å¿«é€Ÿè®°å½•æ”¶å…¥
        if (e.altKey && e.key === 'i') {
            document.querySelector('input[value="income"]').checked = true;
            updateCategoryOptions('income');
            amountInput?.focus();
        }
    });
</script>
{{end}}