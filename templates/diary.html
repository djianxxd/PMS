{{define "content"}}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 mb-2">
                <i class="fas fa-book text-blue-500 mr-3"></i>æˆ‘çš„æ—¥è®°
            </h1>
            <p class="text-slate-600">è®°å½•ç”Ÿæ´»ç‚¹æ»´ï¼Œçè—ç¾å¥½æ—¶å…‰</p>
        </div>
        <button onclick="openAddDiaryModal()" class="btn-primary text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
            <i class="fas fa-plus mr-2"></i>å†™æ—¥è®°
        </button>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stat-card p-6 rounded-xl">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500">æ€»æ—¥è®°æ•°</p>
                    <p class="text-2xl font-bold text-slate-800">{{.TotalCount}}</p>
                </div>
            </div>
        </div>

        <div class="stat-card p-6 rounded-xl">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-layer-group text-green-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500">æœˆä»½æ•°é‡</p>
                    <p class="text-2xl font-bold text-slate-800">{{if .MonthCount}}{{.MonthCount}}{{else}}0{{end}}</p>
                </div>
            </div>
        </div>

        <div class="stat-card p-6 rounded-xl">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-sun text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500">ä»Šæ—¥å¿ƒæƒ…</p>
                    <p class="text-2xl">{{if .TodayMood}}{{.TodayMood}}{{else}}ğŸ˜Š{{end}}</p>
                </div>
            </div>
        </div>

        <div class="stat-card p-6 rounded-xl">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-fire text-purple-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500">è¿ç»­è®°å½•</p>
                    <p class="text-2xl font-bold text-slate-800">{{if .CurrentStreak}}{{.CurrentStreak}}{{else}}0{{end}}å¤©</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Diaries List -->
    <div class="space-y-6">
        {{if .DiaryGroups}}
            {{range $month, $diaries := .DiaryGroups}}
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                        <i class="fas fa-calendar-alt text-blue-500 mr-3"></i>{{$month}}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {{range $diaries}}
                            <div class="bg-white rounded-xl p-5 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:-translate-y-1" onclick="viewDiary({{.ID}})">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="font-semibold text-slate-800 text-lg flex-1 mr-2">{{.Title}}</h4>
                                    <div class="flex space-x-1">
                                        <button onclick="event.stopPropagation(); editDiary({{.ID}})" class="text-blue-500 hover:text-blue-700 p-1">
                                            <i class="fas fa-edit text-sm"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); deleteDiary({{.ID}})" class="text-red-500 hover:text-red-700 p-1">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-3 text-sm text-slate-500 mb-3">
                                    <span class="flex items-center">
                                        <i class="fas fa-calendar-day mr-1"></i>
                                        {{.Date.Format "01-02"}}
                                    </span>
                                    <span class="flex items-center">
                                        {{if eq .Weather "sunny"}}â˜€ï¸ æ™´å¤©
                                        {{else if eq .Weather "cloudy"}}â˜ï¸ å¤šäº‘
                                        {{else if eq .Weather "rainy"}}ğŸŒ§ï¸ é›¨å¤©
                                        {{else if eq .Weather "snowy"}}â„ï¸ é›ªå¤©
                                        {{else if eq .Weather "windy"}}ğŸ’¨ å¤§é£
                                        {{else}}ğŸŒ¤ï¸ å…¶ä»–
                                        {{end}}
                                    </span>
                                    <span class="text-xl">{{.Mood}}</span>
                                </div>
                                
                                <p class="text-slate-600 text-sm line-clamp-3">
                                    {{.Content}}
                                </p>
                                
                                <div class="mt-3 text-xs text-slate-400">
                                    åˆ›å»ºäº {{.CreatedAt.Format "15:04"}}
                                </div>
                            </div>
                        {{end}}
                    </div>
                </div>
            {{end}}
        {{else}}
            <div class="glass-panel rounded-2xl p-12 text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-book-open text-blue-600 text-3xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-slate-800 mb-2">è¿˜æ²¡æœ‰æ—¥è®°</h3>
                <p class="text-slate-600 mb-6">å¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€ç¯‡æ—¥è®°å§ï¼</p>
                <button onclick="openAddDiaryModal()" class="btn-primary text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                    <i class="fas fa-plus mr-2"></i>å†™ç¬¬ä¸€ç¯‡æ—¥è®°
                </button>
            </div>
        {{end}}
    </div>
</div>

<!-- Add/Edit Diary Modal -->
<div id="diaryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-slate-100">
            <h3 class="text-xl font-bold text-slate-800" id="modalTitle">å†™æ—¥è®°</h3>
        </div>
        <form id="diaryForm" class="p-6 space-y-4">
            <input type="hidden" id="diaryId" name="id">
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æ ‡é¢˜</label>
                <input type="text" id="diaryTitle" name="title" required
                    class="input-field w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-blue-500"
                    placeholder="ç»™ä»Šå¤©èµ·ä¸ªæ ‡é¢˜...">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">æ—¥æœŸ</label>
                <input type="date" id="diaryDate" name="date" required
                    class="input-field w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">å¤©æ°”</label>
                    <select id="diaryWeather" name="weather"
                        class="input-field w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-blue-500">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="sunny">â˜€ï¸ æ™´å¤©</option>
                        <option value="cloudy">â˜ï¸ å¤šäº‘</option>
                        <option value="rainy">ğŸŒ§ï¸ é›¨å¤©</option>
                        <option value="snowy">â„ï¸ é›ªå¤©</option>
                        <option value="windy">ğŸ’¨ å¤§é£</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">å¿ƒæƒ…</label>
                    <div class="flex space-x-2">
                        <button type="button" onclick="selectMood('ğŸ˜Š')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ˜Š</button>
                        <button type="button" onclick="selectMood('ğŸ˜”')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ˜”</button>
                        <button type="button" onclick="selectMood('ğŸ˜¡')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ˜¡</button>
                        <button type="button" onclick="selectMood('ğŸ˜')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ˜</button>
                        <button type="button" onclick="selectMood('ğŸ¥°')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ¥°</button>
                        <button type="button" onclick="selectMood('ğŸ˜´')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ˜´</button>
                        <button type="button" onclick="selectMood('ğŸ¤”')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ¤”</button>
                        <button type="button" onclick="selectMood('ğŸ˜¤')" class="mood-btn text-2xl p-2 rounded hover:bg-slate-100">ğŸ˜¤</button>
                    </div>
                    <input type="hidden" id="diaryMood" name="mood" required>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å†…å®¹</label>
                <textarea id="diaryContent" name="content" rows="8" required
                    class="input-field w-full px-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:border-blue-500 resize-none"
                    placeholder="è®°å½•ä»Šå¤©å‘ç”Ÿçš„äº‹æƒ…ã€ä½ çš„æ„Ÿå—ã€æƒ³æ³•..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeDiaryModal()"
                    class="px-6 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
                    å–æ¶ˆ
                </button>
                <button type="submit"
                    class="btn-primary text-white px-6 py-2 rounded-lg hover:shadow-lg transition-all">
                    ä¿å­˜
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Diary Modal -->
<div id="viewDiaryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-slate-100">
            <h3 class="text-xl font-bold text-slate-800" id="viewModalTitle">æ—¥è®°è¯¦æƒ…</h3>
        </div>
        <div id="diaryContent" class="p-6">
            <!-- Content will be loaded here -->
        </div>
        <div class="p-6 border-t border-slate-100 flex justify-end">
            <button onclick="closeViewDiaryModal()"
                class="px-6 py-2 text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors">
                å…³é—­
            </button>
        </div>
    </div>
</div>

<script>
let selectedMood = '';

function openAddDiaryModal() {
    document.getElementById('modalTitle').textContent = 'å†™æ—¥è®°';
    document.getElementById('diaryForm').reset();
    document.getElementById('diaryId').value = '';
    document.getElementById('diaryDate').value = new Date().toISOString().split('T')[0];
    selectedMood = '';
    updateMoodButtons();
    document.getElementById('diaryModal').classList.remove('hidden');
}

function closeDiaryModal() {
    document.getElementById('diaryModal').classList.add('hidden');
}

function selectMood(mood) {
    selectedMood = mood;
    document.getElementById('diaryMood').value = mood;
    updateMoodButtons();
}

function updateMoodButtons() {
    document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-500');
        if (btn.textContent.trim() === selectedMood) {
            btn.classList.add('bg-blue-100', 'ring-2', 'ring-blue-500');
        }
    });
}

function viewDiary(id) {
    fetch(`/diary/get?id=${id}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('diaryContent').innerHTML = html;
            document.getElementById('viewDiaryModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function closeViewDiaryModal() {
    document.getElementById('viewDiaryModal').classList.add('hidden');
}

function editDiary(id) {
    fetch(`/diary/get?id=${id}&format=json`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æ—¥è®°';
            document.getElementById('diaryId').value = data.id;
            document.getElementById('diaryTitle').value = data.title;
            document.getElementById('diaryContent').value = data.content;
            document.getElementById('diaryWeather').value = data.weather;
            document.getElementById('diaryDate').value = data.date.split('T')[0];
            selectMood(data.mood);
            document.getElementById('diaryModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('åŠ è½½æ—¥è®°å¤±è´¥ï¼Œè¯·é‡è¯•');
        });
}

function deleteDiary(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/diary/delete';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'id';
        input.value = id;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

// Form submission
document.getElementById('diaryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const id = formData.get('id');
    const action = id ? '/diary/update' : '/diary/add';
    
    fetch(action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});

// Close modals when clicking outside
document.getElementById('diaryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDiaryModal();
    }
});

document.getElementById('viewDiaryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeViewDiaryModal();
    }
});
</script>
{{end}}